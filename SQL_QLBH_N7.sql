CREATE DATABASE WINQLBANHANG
GO

CREATE TABLE KHACHHANG
(
	MAKH NVARCHAR(10) NOT NULL PRIMARY KEY,
	TENKH NVARCHAR(50),
	DIACHI NVARCHAR(50),
	DIENTHOAI NVARCHAR(50)
)
INSERT dbo.KHACHHANG
(
    MAKH,
    TENKH,
    DIACHI,
    DIENTHOAI
)
VALUES
(N'KH01',N'Trần Thái Nguyên',N'266 Tô Hiến Thành',N'0945373250'),
(N'KH02',N'Đoàn Văn Đức',N'51 Thành Thái',N'0349633678'),
(N'KH03',N'Nguyễn Văn Toàn',N'21 Nguyễn Thị Thực, Phường 2, Quận 3',N'0909365872'),
(N'KH04',N'Trần Tấn Trung',N'25/3C xã Bà Điểm, huyện Hóc Môn',N'0789654342'),
(N'KH05',N'Denni Trần',N'20/5A xã Nghĩa Lạc, huyện Nghĩa Hưng',N'0987675657'),
(N'KH06',N'Trần Văn Tiến',N'18 Gò Vấp', N'0949888203'),
(N'KH07',N'Trương Duy Khanh',N'256 Nguyễn Văn Cừ',N'0364494988'),
(N'KH08',N'Lê Thị Thanh Chúc',N'30 Lê Quý Đôn, phường Võ Thị Sáu, Quận 3',N'0969780427');


CREATE TABLE NHANVIEN 
(
	MANV NVARCHAR(10) NOT NULL PRIMARY KEY,
	TENNV NVARCHAR(50),
	GIOITINH NVARCHAR(10),
	DIENTHOAI NVARCHAR(15),
	NGAYSINH DATETIME,
	DIACHI NVARCHAR(500)
)
INSERT dbo.NHANVIEN
(
    MANV,
    TENNV,
    GIOITINH,
    DIENTHOAI,
    NGAYSINH,
	DIACHI
)
VALUES
(N'NV001',N'Phạm Nguyệt Anh',N'Nữ',N'0967567876','2002-11-05',N'75 Phú Nhuận'),
(N'NV002',N'Nguyễn Minh Huy',N'Nam',N'0876231456','2001-12-23',N'23 Thành Thái'),
(N'NV003',N'Phạm Quang Dự',N'Nam',N'0678987678','1999-01-01',N'40 Sư Vạn Hạnh'),
(N'NV004',N'Nguyễn Khánh Duy',N'Nam',N'0818978258','2003-06-08',N'300 Cầu Giấy'),
(N'NV005',N'Phước Công Nguyên',N'Nam',N'0915200360','2002-08-01',N'200 Thái Thượng Lãng Ông'),
(N'NV006',N'Phạm Trương Gia Hân',N'Nữ',N'0848046390','2000-09-13',N'75 Trương Định');

CREATE TABLE TKNHANVIEN (
	TENTK NVARCHAR(50) NOT NULL PRIMARY KEY,
	MATKHAU NVARCHAR(50)
)
INSERT dbo.TKNHANVIEN (
	TENTK,
	MATKHAU
)
VALUES 
(N'phamnguyetanh',N'phamnguyetanh'),
(N'nguyenminhhuy',N'nguyenminhhuy'),
(N'phamquandu',N'phamquandu'),
(N'nguyenkhanhduy',N'nguyenkhanhduy'),
(N'phuoccongnuyen',N'phuoccongnuyen'),
(N'phamtruonggiahan',N'phamtruonggiahan');

CREATE TABLE CHATLIEU
(
	MACL NVARCHAR(10) NOT NULL PRIMARY KEY,
	TENCL NVARCHAR(50)
)
INSERT dbo.CHATLIEU
(
    MACL,
    TENCL
)
VALUES
(N'TT',N'Thủy tinh'),
(N'PL',N'Pha lê'),
(N'GĐ',N'Gỗ đồng'),
(N'MI',N'MICA'),
(N'NH',N'Nhựa'),
(N'TR',N'Tre'),
(N'S',N'Sợi cacbon'),
(N'V',N'Vãi'),
(N'NLHC',N'Nguyên liệu hữu cơ'),
(N'G',N'Gốm'),
(N'Su',N'Sứ'),
(N'CS',N'Cao su'),
(N'I',N'Inox'),
(N'MN',N'Mã não'),
(N'D',N'Da'),
(N'CT',N'Cẩm thạch'),
(N'B',N'Bạc'),
(N'M',N'Mây'),
(N'VO',N'Vỏ ốc');

CREATE TABLE HOADONBAN (
    MAHDBAN    NVARCHAR (100) NOT NULL PRIMARY KEY,
    MANV NVARCHAR (10) NOT NULL ,
    NGAYBAN    DATETIME,
    MAKH    NVARCHAR (10) NOT NULL,
    TONGTIEN  FLOAT
)
INSERT dbo.HOADONBAN
(
    MAHDBAN,
    MANV,
    NGAYBAN,
    MAKH,
    TONGTIEN
)
VALUES
(N'HD001',N'NV001','2022-01-01',N'KH01',105.0),
(N'HD002',N'NV001','2022-01-01',N'KH02',500.0),
(N'HD003',N'NV001','2022-01-02',N'KH02',135.0),
(N'HD004',N'NV002','2022-01-02',N'KH03',160.0),
(N'HD005',N'NV002','2022-01-02',N'KH03',280.0),
(N'HD006',N'NV002','2022-01-04',N'KH03',275.0),
(N'HD007',N'NV002','2022-01-04',N'KH04',128.0),
(N'HD008',N'NV003','2022-01-04',N'KH04',315.0),
(N'HD009',N'NV003','2022-01-04',N'KH05',192.0),
(N'HD010',N'NV003','2022-01-05',N'KH05',200.0),
(N'HD011',N'NV004','2022-01-05',N'KH04',96.0),
(N'HD012',N'NV004','2022-01-05',N'KH06',125.0),
(N'HD013',N'NV006','2022-01-06',N'KH06',320.0),
(N'HD014',N'NV005','2022-01-06',N'KH05',224.0),
(N'HD015',N'NV006','2022-01-06',N'KH03',270.0),
(N'HD016',N'NV005','2022-01-07',N'KH01',225.0),
(N'HD017',N'NV005','2022-01-07',N'KH01',300.0),
(N'HD018',N'NV004','2022-01-08',N'KH03',25.0),
(N'HD019',N'NV003','2022-01-08',N'KH05',360.0),
(N'HD020',N'NV002','2022-01-09',N'KH06',1100.0),
(N'HD021',N'NV003','2022-01-10',N'KH05',135.0),
(N'HD022',N'NV003','2022-01-12',N'KH07',125.0),
(N'HD023',N'NV005','2022-01-13',N'KH04',90.0),
(N'HD024',N'NV006','2022-01-15',N'KH08',270.0),
(N'HD025',N'NV002','2022-01-17',N'KH03',80.0),
(N'HD026',N'NV002','2022-01-18',N'KH08',224.0),
(N'HD027',N'NV001','2022-01-20',N'KH07',800.0),
(N'HD028',N'NV002','2022-01-21',N'KH05',288.0),
(N'HD029',N'NV001','2022-01-25',N'KH03',450.0),
(N'HD030',N'NV001','2022-01-26',N'KH01',400.0);

CREATE TABLE HANG
(
	MAHANG NVARCHAR(10) NOT NULL PRIMARY KEY,
	TENHANG NVARCHAR(50),
	MACL NVARCHAR(10) NOT NULL,
	SOLUONG INT,
	DONGIANHAP FLOAT,
	DONGIABAN FLOAT,
	ANH NVARCHAR(MAX),
	GHICHU NVARCHAR(200)
)

INSERT dbo.HANG
(
    MAHANG,
    TENHANG,
    MACL,
    SOLUONG,
    DONGIANHAP,
    DONGIABAN,
	ANH,
    GHICHU
)
VALUES
(N'H01',N'Móc khóa pikachu',N'NH',50,20.0,45.0,N'D:\LAP TRINH C#\HINH ANH\H1.jpg',N''),
(N'H02',N'Gấu bông pikachu',N'V',34,50.0,100.0,N'D:\LAP TRINH C#\HINH ANH\H2.jpg',N''),
(N'H03',N'Vòng tay màu hống',N'NH',15,12.0,32.0,N'D:\LAP TRINH C#\HINH ANH\H3.jpg',N''),
(N'H04',N'ly uống nước',N'TT',100,20.0,40.0,N'D:\LAP TRINH C#\HINH ANH\H4.jpg',N''),
(N'H05',N'Kẹp tóc',N'NH',90,15.0,25.0,N'D:\LAP TRINH C#\HINH ANH\H5.jpg',N''),
(N'H06',N'Chiến binh mùa đông',N'NH',50,65.5,125.5,N'D:\LAP TRINH C#\HINH ANH\H6.jpg',N''),
(N'H07',N'Tom no Ben',N'NH',10,444.4,777.5,N'D:\LAP TRINH C#\HINH ANH\H7.jpg',N''),
(N'H08',N'Dây chuyền cẩm thạch',N'CT',19,264.4,347.5,N'D:\LAP TRINH C#\HINH ANH\H8.jpg',N''),
(N'H09',N'Grill bạc nguyên chất',N'B',10,1400.5,2000.5,N'D:\LAP TRINH C#\HINH ANH\H9.jpg',N''),
(N'H10',N'Tranh vỏ ốc',N'VO',8,423.4,945.5,N'D:\LAP TRINH C#\HINH ANH\H10.jpg',N''),
(N'H11',N'Vòng tay mã não',N'MN',50,234.3,287.9,N'D:\LAP TRINH C#\HINH ANH\H11.jpg',N'');

CREATE TABLE CHITIETHOADONBAN
(
	MAHDBAN NVARCHAR(100) NOT NULL,
	MAHANG NVARCHAR(10) NOT NULL,
	SOLUONG FLOAT,
	DONGIA FLOAT,
	GIAMGIA FLOAT,
	THANHTIEN FLOAT
)
INSERT dbo.CHITIETHOADONBAN
(
    MAHDBAN,
    MAHANG,
    SOLUONG,
    DONGIA,
    GIAMGIA,
    THANHTIEN
)
VALUES
(N'HD001',N'H01',3.0,35.0,0.0,105.0),
(N'HD002',N'H02',5.0,100.0,0.0,500.0),
(N'HD003',N'H01',3.0,35.0,0.0,135.0),
(N'HD004',N'H03',5.0,32.0,0.0,160.0),
(N'HD005',N'H04',7.0,40.0,0.0,280.0),
(N'HD006',N'H05',11.0,25.0,0.0,275.0),
(N'HD007',N'H03',4.0,32.0,0.0,128.0),
(N'HD008',N'H01',7.0,45.0,0.0,315.0),
(N'HD009',N'H03',6.0,32.0,0.0,192.0),
(N'HD010',N'H02',2.0,100.0,0.0,200.0),
(N'HD011',N'H03',3.0,32.0,0.0,96.0),
(N'HD012',N'H05',5.0,25.0,0.0,125.0),
(N'HD013',N'H04',8.0,40.0,0.0,320.0),
(N'HD014',N'H03',7.0,32.0,0.0,224.0),
(N'HD015',N'H01',6.0,45.0,0.0,270.0),
(N'HD016',N'H01',5.0,45.0,0.0,225.0),
(N'HD017',N'H02',3.0,100.0,0.0,300.0),
(N'HD018',N'H05',1.0,25.0,0.0,25.0),
(N'HD019',N'H04',9.0,40.0,0.0,360.0),
(N'HD020',N'H02',11.0,100.0,0.0,1100.0),
(N'HD021',N'H01',3.0, 45.0, 0.0, 135.0),
(N'HD022',N'H05',5.0, 25.0, 0.0, 125.0),
(N'HD023',N'H01',2.0, 45.0, 0.0, 90.0),
(N'HD024',N'H01',6.0, 45.0, 0.0, 270.0),
(N'HD025',N'H04',2.0, 40.0, 0.0, 80.0),
(N'HD026',N'H03',7.0, 32.0, 0.0, 224.0),
(N'HD027',N'H02',8.0, 100.0, 0.0, 800.0),
(N'HD028',N'H03',9.0, 32.0, 0.0, 288.0),
(N'HD029',N'H01',10.0, 45.0, 0.0, 450.0),
(N'HD030',N'H02',4.0, 100.0, 0.0, 400.0);


CREATE TABLE LICHSUDONGIA
(
	MAHANG NVARCHAR(10) NOT NULL,
	DONGIANHAPCU FLOAT,
	DONGIANHAPMOI FLOAT,
	DONGIABANCU FLOAT,
	DONGIABANMOI FLOAT,
	NGAYCAPNHAT DATETIME
)
INSERT dbo.LICHSUDONGIA
(
    MAHANG,
    DONGIANHAPCU,
    DONGIANHAPMOI,
    DONGIABANCU,
    DONGIABANMOI,
    NGAYCAPNHAT
)
VALUES
(N'H01',30.0,40.0,50.0,60.0,'2000-01-01'),
(N'H01',40.0,20.0,60.0,45.0,'2022-01-01'),
(N'H02',40.0,50.0,90.0,100.0,'2019-01-01'),
(N'H03',10.0,12.0,30.0,32.0,'2020-01-01'),
(N'H04',15.0,20.0,35.0,40.0,'2018-02-02'),
(N'H05',40.0,30.0,60.0,60.0,'2017-05-09'),
(N'H05',30.0,15.0,60.0,25.0,'2019-07-08'),
(N'H06',30.0,65.5,60.0,125.5,'2019-06-08'),
(N'H07',300.0,444.4,600.0,777.5,'2019-01-08'),
(N'H08',200.4,264.4,250.0,347.5,'2022-01-05'),
(N'H09',1000.5,1400.5,1200.9,2000.5,'2020-09-08'),
(N'H10',308.0,423.4,665.0,945.5,'2021-11-08'),
(N'H11',204.0,234.3,266.0,287.9,'2019-01-03');

CREATE TABLE NHACUNGCAP
(
	MANCC NVARCHAR(10) NOT NULL PRIMARY KEY,
	TENNCC NVARCHAR(50),
	MAHANGCC NVARCHAR(10)
)
INSERT dbo.NHACUNGCAP
(
    MANCC,
    TENNCC,
    MAHANGCC
)
VALUES
(N'NCC01',N'Trung tâm sản xuất móc khóa',N'H01'),
(N'NCC02',N'Công ty sản xuất gấu bông',N'H02'),
(N'NCC03',N'Trung tâm làm vòng tay',N'H03'),
(N'NCC04',N'Công ty sản xuất đồ thủy tinh',N'H04'),
(N'NCC05',N'Cửa hàng làm kẹp',N'H05'),
(N'NCC06',N'Công ty phân phối đồ chơi siêu nhân',N'H06'),
(N'NCC07',N'Nhà phân phối độc quyền TomnoBen',N'H07'),
(N'NCC08',N'Làng nghệ nhân Mã Lai',N'H08'),
(N'NCC09',N'Jonny Dang diamond',N'H09'),
(N'NCC10',N'Công ty sứ biển chuyên tranh nghệ thuật',N'H10'),
(N'NCC11',N'Công ty TNHH 1 thành viên trang sức TP.HCM',N'H11');

--Các câu truy vấn
--1 BẢNG CHI TIẾT NHÀ CUNG CẤP 
SELECT N.MANCC,N.TENNCC,H.MAHANG, H.TENHANG
FROM dbo.HANG AS H INNER JOIN dbo.NHACUNGCAP AS N
ON H.MAHANG=N.MAHANGCC

--2 BẢNG CHI TIẾT HÓA ĐƠN CỤ THỂ
SELECT H.MAHDBAN, H.MANV, N.TENNV, H.MAKH, K.TENKH, H.NGAYBAN, CHI.SOLUONG, CHI.DONGIA, CHI.GIAMGIA, H.TONGTIEN
FROM dbo.HOADONBAN AS H 
INNER JOIN dbo.NHANVIEN AS N ON N.MANV = H.MANV
INNER JOIN dbo.KHACHHANG AS K ON K.MAKH = H.MAKH
INNER JOIN dbo.CHITIETHOADONBAN AS CHI ON CHI.MAHDBAN = H.MAHDBAN

--3 GIÁ TRỊ LỚN NHẤT CỦA MẢ HÀNG H01
SELECT MAX(THANHTIEN) AS 'GIATRILONNHAT'
FROM dbo.CHITIETHOADONBAN
WHERE MAHANG = 'H01'

--4 HÓA ĐƠN CÓ TỔNG TIỀN TRÊN 200 (>200)
SELECT H.MAHDBAN, H.MANV, N.TENNV,H.MAKH,K.TENKH, H.NGAYBAN , H.TONGTIEN
FROM dbo.HOADONBAN AS H
INNER JOIN dbo.KHACHHANG AS K ON K.MAKH = H.MAKH
INNER JOIN dbo.NHANVIEN AS N ON N.MANV = H.MANV
WHERE H.TONGTIEN>200

--5 SỐ LẦN CẬP NHẬT GIÁ CỦA TỪNG ĐƠN HÀNG
SELECT MAHANG, COUNT(MAHANG) AS SOLANCAPNHATDONGIA
FROM dbo.LICHSUDONGIA
GROUP BY MAHANG

--6 SỐ TIỀN LỚN NHẤT MÀ CỬA HÀNG THU ĐƯỢC TỪ MỖI LOẠI HÀNG
SELECT MAHANG, MAX(THANHTIEN) AS SOTIENLONNHAT
FROM dbo.CHITIETHOADONBAN
GROUP BY MAHANG 


/*trigger*/
--1 KIỂM TRA THÊM MẶT HÀNG
CREATE TRIGGER TG_HANG_KTHANG ON HANG
FOR INSERT
AS 
BEGIN 
	declare @TENHANG NVARCHAR(50),@MACL NVARCHAR(10)
	SELECT @MACL = MACL, @TENHANG = TENHANG FROM inserted
	IF((select count(*)from HANG where MACL = @MACL AND TENHANG = @TENHANG)>1)
	begin
	raiserror(N'Mặt hàng không hợp lệ',15,1)
	rollback tran
	return
	end
END
insert into HANG (MAHANG,TENHANG,MACL,SOLUONG,DONGIANHAP,DONGIABAN,GHICHU) values
(N'H13',N'Chiến binh wakanda',N'234',50.0,20.0,45.0,N'')

--2 tHÔNG BÁO MẶC HÀNG ĐƯỢC THÊM THÀNH CÔNG
create trigger TG_HANG_success on HANG
FOR INSERT
AS 
BEGIN 
PRINT N'ĐÃ THÊM MẶT HÀNG THÀNH CÔNG'
END

--3 MÃ CHẤT LIỆU ĐƯỢC  THÊM KHÔNG  TRÙNG VỚI MÃ CHẤT LIỆU ĐÃ CÓ
CREATE TRIGGER TG_CHATLIEU_MA  ON  CHATLIEU
FOR INSERT
AS 
BEGIN
	DECLARE @MACL  NVARCHAR(10)
	SELECT @MACL = MACL
	FROM INSERTED
	IF  ((SELECT COUNT(*) FROM dbo.CHATLIEU WHERE MACL=@MACL)>1)
	BEGIN
		RAISERROR (N'MÃ CHẤT LIỆU BỊ TRÙNG',15,1)
		ROLLBACK TRAN
		RETURN
	END
END
INSERT INTO dbo.CHATLIEU
(
    MACL,
    TENCL
)
VALUES
(   N'NH', -- MACL - nvarchar(10)
    N'Nhôm'  -- TENCL - nvarchar(50)
    )

--4 THÔNG BÁO CHẤT LIỆU ĐƯỢC THÊM  THÀNH CÔNG
CREATE TRIGGER TG_CHATLIEU_SUCCESS ON CHATLIEU
FOR INSERT
AS 
BEGIN
	PRINT N'ĐÃ THÊM THÀNH CÔNG CHẤT  LIỆU'
END
INSERT INTO dbo.CHATLIEU
(
    MACL,
    TENCL
)
VALUES
(   N'AL', -- MACL - nvarchar(10)
    N'Nhôm'  -- TENCL - nvarchar(50)
    )

/*FUNCTION*/
--1 XUẤT RA DANH SÁCH NHÂN VIÊN
CREATE FUNCTION UF_SELECTALLNHANVIEN() 
RETURNS TABLE
AS RETURN SELECT * FROM  dbo.NHANVIEN
GO

SELECT*FROM UF_SELECTALLNHANVIEN()

--2 XUẤT TOÀN BỘ NHÀ CUNG CẤP
CREATE FUNCTION UF_SELECTALLNCC()
RETURNS  TABLE
AS RETURN SELECT * FROM dbo.NHACUNGCAP
GO

SELECT*FROM UF_SELECTALLNCC()

--3 XUẤT RA TỔNG TIỀN CVUA3 HÓA ĐƠN  KHI NHẬP MÃ HÓA ĐƠN
CREATE FUNCTION UF_SELECT_HDB(@MAHDB NVARCHAR(10))
RETURNS FLOAT
AS
BEGIN
	DECLARE @TONGTIEN FLOAT
	SELECT @TONGTIEN= TONGTIEN FROM  dbo.HOADONBAN WHERE MAHDBAN=@MAHDB
	RETURN @TONGTIEN
END
SELECT dbo.UF_SELECT_HDB('HD001') AS TONGTIEN
SELECT dbo.UF_SELECT_HDB('HD002') AS TONGTIEN
SELECT dbo.UF_SELECT_HDB('HD003') AS TONGTIEN
SELECT dbo.UF_SELECT_HDB(MAHDBAN) FROM dbo.HOADONBAN

--4 XUẤT  RA THÔNG TIN  CỦA HÓA ĐƠN KHI  NHẬP MÃ HÓA  ĐƠN
CREATE FUNCTION UF_SELECTall_HDB(@MAHDB NVARCHAR(10))
RETURNS TABLE
AS RETURN SELECT * FROM dbo.HOADONBAN WHERE MAHDBAN=@MAHDB

SELECT*FROM dbo.UF_SELECTall_HDB('HD001')

--5 XUẤT RA CÁC HÓA ĐƠN BÁN KHI NHẬP MÃ HÀNG
CREATE FUNCTION UF_SELECTall_CHITIETHOADONBAN (@MAH NVARCHAR(10))
RETURNS TABLE
AS RETURN SELECT * FROM dbo.CHITIETHOADONBAN WHERE MAHANG=@MAH

SELECT*FROM dbo.UF_SELECTall_CHITIETHOADONBAN('H01')